name: Build and Push Docker Images

on:
  push:
    branches:
      - master

env:
  REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        service:
          - { name: "identity-api", dockerfile: "src/Services/Identity/AgroSolutions.Identity.Api/Dockerfile" }
          - { name: "properties-api", dockerfile: "src/Services/Properties/AgroSolutions.Properties.Api/Dockerfile" }
          - { name: "sensors-api", dockerfile: "src/Services/Sensors/AgroSolutions.Sensors.Api/Dockerfile" }
          - { name: "alerts-api", dockerfile: "src/Services/Alerts/AgroSolutions.Alerts.API/Dockerfile" }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo apt-get update
          sudo apt-get remove -y '^ghc-8.*'
          sudo apt-get remove -y '^dotnet-.*'
          sudo apt-get remove -y '^temurin-.*'
          sudo apt-get remove -y mysql-server postgresql
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-options: image=moby/buildkit:latest,network=host

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from tag
        id: meta
        run: |
          VERSION=$(echo ${GITHUB_SHA} | cut -c1-7)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build and push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        timeout-minutes: 25
        with:
          context: .
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/agrosolution-${{ matrix.service.name }}:latest
            ${{ env.DOCKER_USERNAME }}/agrosolution-${{ matrix.service.name }}:${{ steps.meta.outputs.version }}
          cache-from: type=registry,ref=${{ env.DOCKER_USERNAME }}/agrosolution-${{ matrix.service.name }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_USERNAME }}/agrosolution-${{ matrix.service.name }}:buildcache,mode=max

      - name: Log build summary
        if: success()
        run: |
          echo "âœ… Successfully built and pushed ${{ matrix.service.name }}"
          echo "ðŸ“¦ Image: ${{ env.DOCKER_USERNAME }}/agrosolution-${{ matrix.service.name }}:latest"
          echo "ðŸ“¦ Image: ${{ env.DOCKER_USERNAME }}/agrosolution-${{ matrix.service.name }}:${{ steps.meta.outputs.version }}"

  post-build:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Create deployment notification
        run: |
          echo "ðŸŽ‰ All Docker images have been successfully built and pushed to Docker Hub!"
          echo ""
          echo "ðŸ“¦ Images available:"
          echo "   - ${{ secrets.DOCKER_USERNAME }}/agrosolution-identity-api"
          echo "   - ${{ secrets.DOCKER_USERNAME }}/agrosolution-properties-api"
          echo "   - ${{ secrets.DOCKER_USERNAME }}/agrosolution-sensors-api"
          echo "   - ${{ secrets.DOCKER_USERNAME }}/agrosolution-alerts-api"
